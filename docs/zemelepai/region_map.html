<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Regioninis straipsnių žemėlapis — Flat Dark</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>


  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0b0f14; --panel:#0f141b; --muted:#aab3c0; --text:#eaf0f7;
      --brand:#49c6ff; --inactive:#1a2431; --stroke:#1b2432;
      --radius:14px; --shadow:0 10px 40px rgba(0,0,0,.45); --navH:56px;

      /* popup paletė */
      --popupBg:#0d131c; --popupHdr:#111a26;
      --popupStroke:#1a2636; --popupSoft:#9fb3c9;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.45 "Inter",system-ui,-apple-system,Segoe UI,Roboto}
    a{color:inherit;text-decoration:none}
    .leaflet-container{background:var(--bg)}

    /* NAV */
    .nav{height:var(--navH);position:sticky;top:0;z-index:70;display:flex;align-items:center;gap:12px;padding:0 12px;border-bottom:1px solid #121826;background:rgba(10,13,18,.72);backdrop-filter:blur(6px)}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800}
    .brand i{color:var(--brand)}
    .spacer{flex:1}
    .hamburger{display:none;width:38px;height:38px;border-radius:10px;border:1px solid #121826;background:#0c1118;color:#cfeeff;cursor:pointer}
    .account{padding:8px 12px;border-radius:999px;border:1px solid #121826;background:#0c1118;color:#cfeeff;font-weight:700}

    /* LAYOUT */
    .wrap{display:grid;grid-template-columns:300px 1fr;gap:14px;padding:12px}
    .panel{background:var(--panel);border:1px solid #121826;border-radius:var(--radius);box-shadow:var(--shadow)}

    /* SIDEBAR */
    .sidebar{padding:14px;display:flex;flex-direction:column;gap:18px;min-height:calc(100vh - var(--navH) - 24px)}
    .block h3{margin:0 0 10px;font-size:.95rem;color:#dff6ff}
    #nicheBar{display:flex;flex-wrap:wrap;gap:8px}
    #nicheBar .chip{border:1px solid #121826;background:#101725;color:var(--muted);padding:8px 12px;border-radius:999px;font-size:.9rem;cursor:pointer}
    #nicheBar .chip.active{background:#49c6ff;color:#07121a;border-color:transparent;font-weight:700}
    .field{display:flex;flex-direction:column;gap:6px}
    .field select,.field input[type="date"]{background:#0e131d;border:1px solid #121826;color:var(--text);padding:10px 12px;border-radius:10px}

    /* MAP */
    .map-card{position:relative;min-height:calc(100vh - var(--navH) - 24px)}
    #map{height:100%;width:100%;border-radius:12px;border:1px solid #121826;overflow:hidden}

    /* OVERLAYS */
    .overlay{position:absolute;left:12px;top:12px;z-index:400;display:flex;gap:8px;flex-wrap:wrap;pointer-events:none}
    .overlay .pill{pointer-events:auto}
    .pill{display:flex;gap:8px;align-items:center;background:rgba(8,12,18,.76);backdrop-filter:blur(4px);border:1px solid #121826;border-radius:999px;padding:8px 12px;font-size:.9rem;color:#cfe5ff}
    .legend{position:absolute;left:12px;bottom:12px;z-index:400;display:flex;gap:12px;align-items:center;background:rgba(8,12,18,.76);border:1px solid #121826;padding:6px 10px;border-radius:999px;font-size:.9rem;color:#cfe5ff;pointer-events:none}
    .box{width:16px;height:12px;border-radius:3px;border:1px solid #1c2432;display:inline-block}
    .active{background:#49c6ff}.inactive{background:#111a25}

    /* ===== DESKTOP POPUP (refined) ===== */
    .leaflet-container a{color:#cfe5ff}
    .leaflet-popup-content-wrapper{
      background:var(--popupBg);
      color:#eaf3ff;
      border:1px solid var(--popupStroke);
      border-radius:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.55), inset 0 3px 0 rgba(73,198,255,.18);
      overflow:visible;            /* kad sticky dalys nebūtų „nukirstos“ */
    }
    .leaflet-popup-tip{background:var(--popupBg);border:1px solid var(--popupStroke)}
    .popup-card{width:min(780px,92vw);max-height:72vh;display:flex;flex-direction:column}
    .popup-header{
      position:sticky;top:0;display:flex;align-items:center;gap:12px;
      background:linear-gradient(180deg, rgba(17,26,38,.98), rgba(17,26,38,.92));
      backdrop-filter:blur(4px);
      padding:14px 16px;margin:0;border-bottom:1px solid var(--popupStroke);
      border-radius:14px 14px 0 0
    }
    .popup-flag{width:28px;height:28px;border-radius:8px;background:#0f1926;border:1px solid var(--popupStroke);display:grid;place-items:center;flex:0 0 auto}
    .popup-flag i{color:var(--brand)}
    .popup-title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .popup-count{margin-left:auto;font-size:.85rem;color:var(--popupSoft);background:#0f1a27;border:1px solid var(--popupStroke);border-radius:999px;padding:6px 10px}
    .popup-list{
      overflow:auto;
      padding:10px 16px 88px;  /* apačioje vieta veiksmų juostai */
      scrollbar-width:thin;
    }
    .popup-list::-webkit-scrollbar{height:8px;width:8px}
    .popup-list::-webkit-scrollbar-thumb{background:#1b2a3e;border-radius:6px}
    .article{
      display:grid;grid-template-columns:96px 1fr;gap:14px;
      padding:12px;border:1px solid #1e2a3a;border-radius:12px;
      background:#0d1622; margin:10px 0;
      transition:transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .article:hover{transform:translateY(-1px);border-color:#253549;background:#0e1a28}
    .thumb{width:96px;height:96px;border-radius:12px;border:1px solid #1a2a40;object-fit:cover;background:#0c1220}
    .meta{display:flex;flex-direction:column;gap:6px;min-width:0}
    .meta .title a{font-weight:750;line-height:1.22}
    .meta .title a:hover{text-decoration:underline}
    .row{display:flex;gap:10px;align-items:center;font-size:.84rem;color:#a9b6c9;flex-wrap:wrap}
    .badge{padding:3px 8px;border-radius:999px;background:#0f1a27;border:1px solid #1b2b40;font-size:.78rem}
    .summary{font-size:.94rem;color:#d7dfe9;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .popup-actions{
      position:sticky;bottom:0;display:flex;gap:8px;justify-content:flex-end;
      background:linear-gradient(to top, rgba(13,19,28,1), rgba(13,19,28,0.75), rgba(13,19,28,0));
      padding:12px 16px;margin:0;border-top:1px solid var(--popupStroke)
    }
    .btn{border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:800;letter-spacing:.2px}
    .btn.primary{background:linear-gradient(180deg,#58ceff,#39b8ff);color:#05131d}
    .btn.ghost{background:#0f1a27;color:#dff6ff;border:1px solid #1a2334}

    /* MOBILE */
    @media (max-width: 900px){
      .hamburger{display:flex}
      .wrap{grid-template-columns:1fr}
      #drawerBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:900;display:none}
      .drawer-open #drawerBackdrop{display:block}
      .sidebar{
        position:fixed;left:12px;top:calc(var(--navH) + 12px);z-index:950;
        width:min(86vw,380px);transform:translateX(-120%);transition:transform .2s ease;
        box-shadow:0 20px 60px rgba(0,0,0,.55)
      }
      .sidebar.open{transform:translateX(0)}
      .drawer-open .overlay,.drawer-open .leaflet-control-container{opacity:0;pointer-events:none}
      .leaflet-popup{display:none !important}
    }

    /* BOTTOM SHEET (mobile) */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1000;display:none}
    .sheet{position:fixed;left:0;right:0;bottom:0;z-index:1001;background:var(--popupBg);border-top:1px solid var(--popupStroke);border-radius:16px 16px 0 0;max-height:90vh;transform:translateY(100%);transition:transform .22s ease;box-shadow:0 -18px 50px rgba(0,0,0,.6)}
    .sheet.open{transform:translateY(0)}
    .sheet-backdrop.open{display:block}
    .sheet-header{position:sticky;top:0;background:var(--popupHdr);border-bottom:1px solid var(--popupStroke);padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-radius:16px 16px 0 0}
    .sheet-title{font-weight:800}
    .sheet-count{font-size:.85rem;color:var(--popupSoft);background:#0f1a27;border:1px solid var(--popupStroke);border-radius:999px;padding:6px 10px}
    .sheet-body{
      padding:10px 14px 88px;  /* apačioje vieta veiksmų juostai */
      overflow:auto;
      max-height:calc(90vh - 56px - 58px);
    }
    .sheet-actions{position:sticky;bottom:0;padding:10px 14px;display:flex;gap:8px;justify-content:flex-end;background:linear-gradient(to top, rgba(13,19,28,1), rgba(13,19,28,0));border-top:1px solid var(--popupStroke)}
    .sheet .article{display:grid;grid-template-columns:1fr;gap:8px;padding:10px 0;border-bottom:1px dashed #1a2340}
    .sheet .thumb{width:100%;height:160px}
  </style>
</head>
<body>
  <div id="drawerBackdrop"></div>

  <header class="nav">
    <button class="hamburger" id="toggleSidebar" aria-label="Meniu"><i class="fa-solid fa-bars"></i></button>
    <div class="brand"><i class="fa-solid fa-globe"></i> NewNews4You</div>
    <div class="spacer"></div>
    <a href="../login.html" class="account">Mano paskyra</a>
  </header>

  <main class="wrap">
    <aside class="panel sidebar" id="sidebar">
      <section class="block">
        <h3>Kategorijos</h3>
        <div id="nicheBar"></div>
      </section>
      <section class="block">
        <h3>Filtrai</h3>
        <div class="field"><label for="countryFilter">Šalis</label><select id="countryFilter"></select></div>
        <div class="field"><label for="dateFrom">Nuo</label><input type="date" id="dateFrom"/></div>
        <div class="field"><label for="dateTo">Iki</label><input type="date" id="dateTo"/></div>
      </section>
    </aside>

    <section class="panel map-card">
      <div class="overlay">
        <div class="pill"><i class="fa-regular fa-flag"></i><span id="activeCountries">0 šalys</span></div>
        <div class="pill"><i class="fa-regular fa-file-lines"></i><span id="totalArticles">0 straipsnių</span></div>
        <div class="pill"><i class="fa-regular fa-clock"></i><span id="lastUpdated">Atnaujinta šiandien</span></div>
      </div>
      <div id="map"></div>
      <div class="legend">
        <span><span class="box active"></span> Yra straipsnių</span>
        <span><span class="box inactive"></span> Nėra duomenų</span>
      </div>
    </section>
  </main>

  <!-- Mobile bottom sheet -->
  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="sheet" id="sheet">
    <div class="sheet-header">
      <div class="sheet-title" id="sheetTitle">Šalis</div>
      <div class="sheet-count" id="sheetCount">0 straipsnių</div>
    </div>
    <div class="sheet-body" id="sheetBody"></div>
    <div class="sheet-actions" id="sheetActions"></div>
  </div>

  <script>
    /* Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyDzf4GlqlOEtCOYWdmpAz7n5BZvdb1QARg",
  authDomain: "news4you-f0976.firebaseapp.com",
  projectId: "news4you-f0976",
  storageBucket: "news4you-f0976.firebasestorage.app",
  messagingSenderId: "101311076335",
  appId: "1:101311076335:web:bbd5e29306269902e1881a",
  measurementId: "G-PTVWMT02K2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    const analytics = firebase.analytics();

// Pasirinktinai: loginantis priskirk userId Analytics'ui
auth.onAuthStateChanged(user => {
  if (user) {
    analytics.setUserId(user.uid);
  } else {
    analytics.setUserId(null);
  }
});


    /* State */
    let map, geoJsonLayer;
    let regionArticles = {};
    let selectedCountry = '';
    let selectedNiche   = 'Visos';
    let userNiches      = [];

    const $ = s => document.querySelector(s);
    const urlParam = k => new URL(location.href).searchParams.get(k);
    const iso = d => new Date(d).toISOString().split('T')[0];
    const fmt = d => new Date(d).toLocaleDateString('lt-LT',{year:'numeric',month:'short',day:'2-digit'});

    /* Režimas: sheet (mobile) vs popup (desktop) */
    const isMobileWidth = () => window.innerWidth <= 900;
    let USE_SHEET = isMobileWidth();
    function recheckModeAndReload(){
      const prev = USE_SHEET;
      USE_SHEET = isMobileWidth();
      if (USE_SHEET !== prev){
        try { map.closePopup(); } catch(_) {}
        closeSheet();
        loadMapLayer();
      }
    }

    /* Zoom */
    const ZMIN = 2, ZMAX = 6, ZSTEP = 0.25;
    const PADS = { paddingTopLeft:[20,20], paddingBottomRight:[24,60] };

    /* Drawer */
    const toggleBtn = $('#toggleSidebar');
    const sidebarEl = $('#sidebar');
    const drawerBg  = $('#drawerBackdrop');
    function setDrawer(open){
      if (open) closeSheet();
      sidebarEl.classList.toggle('open', open);
      document.body.classList.toggle('drawer-open', open);
      drawerBg.style.display = open ? 'block' : 'none';
      setTimeout(()=> map.invalidateSize(), 220);
    }
    toggleBtn.addEventListener('click', ()=> setDrawer(!sidebarEl.classList.contains('open')));
    drawerBg.addEventListener('click', ()=> setDrawer(false));

    /* Bottom sheet */
    const sheet = $('#sheet'), sheetBg = $('#sheetBackdrop'), sheetBody = $('#sheetBody'), sheetActions = $('#sheetActions');
    function openSheet(html, title, count){
      sheetBody.innerHTML = html;
      $('#sheetTitle').textContent = title;
      $('#sheetCount').textContent = `${count} straipsniai`;
      sheet.classList.add('open'); sheetBg.classList.add('open');
      disableMap(true);
    }
    function closeSheet(){
      sheet.classList.remove('open'); sheetBg.classList.remove('open');
      disableMap(false);
    }
    sheetBg.addEventListener('click', closeSheet);

    function disableMap(disable){
      const m = map; if (!m) return;
      const fn = disable ? 'disable' : 'enable';
      m.dragging[fn](); m.scrollWheelZoom[fn](); m.doubleClickZoom[fn](); m.boxZoom[fn](); m.keyboard[fn]();
      if (m.touchZoom) m.touchZoom[fn]();
      if (m.tap) m.tap[fn]();
    }
    document.addEventListener("DOMContentLoaded", () => {
  if (typeof gtag !== "undefined") {
    // Saugumo sumetimais – jeigu GA dar neinic.
    gtag('event', 'site_open', { page_path: location.pathname });
  } else if (analytics && analytics.logEvent) {
    analytics.logEvent('site_open', { page_path: location.pathname });
  }
});

    /* Map init */
    document.addEventListener("DOMContentLoaded", () => {
      map = L.map('map', {
        worldCopyJump:true,
        zoomControl:true,
        zoomSnap:ZSTEP,
        zoomDelta:ZSTEP,
        preferCanvas:true,
        minZoom:ZMIN,
        maxZoom:ZMAX
      }).setView([20,0], ZMIN);
      map.setMaxBounds([[-85,-200],[85,200]]);
      map.zoomControl.setPosition('bottomright');

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          const doc = await db.collection('users').doc(user.uid).get();
          userNiches = doc.exists && doc.data().niches ? doc.data().niches : [];
        } else userNiches = [];
        loadData();
      });

      // Filtrai
      $('#countryFilter').addEventListener('change', e=>{ selectedCountry=e.target.value; loadMapLayer(); if (USE_SHEET) setDrawer(false); });
      $('#dateFrom').addEventListener('change', ()=>{ loadMapLayer(); if (USE_SHEET) setDrawer(false); });
      $('#dateTo').addEventListener('change', ()=>{ loadMapLayer(); if (USE_SHEET) setDrawer(false); });

      window.addEventListener('resize', ()=>{
        map.invalidateSize();
        recheckModeAndReload();
      });
    });

    async function loadData(){
      const res = await fetch("../map_data/region_map.json");
      regionArticles = await res.json();
      const np = urlParam("niche"); if (np) selectedNiche = np;
      populateCountryFilter(); populateNicheFilter(); loadMapLayer();
    }

    function populateCountryFilter(){
      const el = $('#countryFilter');
      el.innerHTML = '<option value="">Visos</option>';
      Object.keys(regionArticles).sort().forEach(c=>{
        const o = document.createElement('option'); o.value=c; o.textContent=c; el.appendChild(o);
      });
      if (selectedCountry) el.value = selectedCountry;
    }
    function populateNicheFilter(){
      const bar = $('#nicheBar');
      const set = new Set();
      Object.values(regionArticles).forEach(list=>list.forEach(a=>{ if(a.niche) set.add(a.niche); }));
      const allowed = userNiches.length ? [...set].filter(n=>userNiches.includes(n)) : [...set];
      allowed.sort();
      bar.innerHTML='';
      ['Visos', ...allowed.filter(n=>n!=='Visos')].forEach(niche=>{
        const b = document.createElement('button');
        b.className='chip' + (niche===selectedNiche?' active':'');
        b.textContent=niche;
        b.onclick=()=>{
          selectedNiche=niche;
          document.querySelectorAll('#nicheBar .chip').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          loadMapLayer();
          focusActiveByNiche(); // pritraukimas
          if (USE_SHEET) setDrawer(false);
        };
        bar.appendChild(b);
      });
    }

    function filterArticles(country){
      const from = $('#dateFrom').value, to = $('#dateTo').value;
      let items = regionArticles[country] || [];
      if (selectedNiche !== 'Visos') items = items.filter(a=>a.niche===selectedNiche);
      if (selectedCountry && selectedCountry !== country) return [];
      if (from) items = items.filter(a => new Date(a.date) >= new Date(from));
      if (to)   items = items.filter(a => new Date(a.date) <= new Date(to));
      return items;
    }

    const countryHasArticles = n => filterArticles(n).length>0;
    function styleFor(feature){
      const has = countryHasArticles(feature.properties.name);
      const z = map.getZoom(), w = z >= 5 ? 0.9 : z >= 3.5 ? 0.7 : 0.5;
      return has
        ? { color:"#162031", weight:w, fillColor:"#49c6ff", fillOpacity:0.9 }
        : { color:"#131b28", weight:w, fillColor:"#1a2431", fillOpacity:0.35 };
    }

    function loadMapLayer(){
      let total=0, active=0;
      Object.keys(regionArticles).forEach(c=>{ const l=filterArticles(c); total+=l.length; if(l.length) active++; });
      document.getElementById('totalArticles').textContent = `${total} straipsnių`;
      document.getElementById('activeCountries').textContent = `${active} šalys`;
      document.getElementById('lastUpdated').textContent    = `Atnaujinta ${iso(new Date())}`;

      fetch("../map_data/countries.geo.json")
        .then(r=>r.json())
        .then(world=>{
          if (geoJsonLayer) geoJsonLayer.remove();
          world.features = world.features.filter(f => (f.properties?.name || f.properties?.NAME) !== 'Antarctica');

          geoJsonLayer = L.geoJSON(world, {
            style: styleFor,
            onEachFeature: (feature, layer) => {
              const country = feature.properties.name;
              const list = filterArticles(country);
              if(!list.length) return;

              if (USE_SHEET){
                // MOBILE: bottom sheet
                layer.on('click', ()=>{
                  const first = list.slice(0,1);
                  openSheet(buildArticlesHTML(first), country, list.length);
                  sheetActions.innerHTML = list.length>1
                    ? `<button type="button" class="btn primary" data-action="more" data-country="${country}">Rodyti daugiau</button>`
                    : '';
                });
              } else {
                // DESKTOP: Leaflet popup (refined UI)
                layer.bindPopup(
                  popupHTML(country, list, true),
                  { maxWidth: 820, minWidth: 380, className: 'nn-popup', closeOnClick:false }
                );
                layer.on({
                  mouseover:e=>e.target.setStyle({fillOpacity:1}),
                  mouseout:e=>e.target.setStyle(styleFor(feature))
                });
              }
            }
          }).addTo(map);

          map.off('zoomend._style').on('zoomend._style', ()=> geoJsonLayer.setStyle(styleFor));

          if (!USE_SHEET){
            map.off('popupopen._nn').on('popupopen._nn', (e) => {
              const el = e.popup.getElement();
              if (el){
                L.DomEvent.disableClickPropagation(el);
                L.DomEvent.disableScrollPropagation(el);
              }
            });
          }
        });
    }

    /* Auto-pritraukimas tik pasirinkus nišą */
    function focusActiveByNiche(){
      if (!geoJsonLayer) return;
      const boundsArr=[];
      geoJsonLayer.eachLayer(l=>{
        const name = l.feature?.properties?.name;
        if (name && countryHasArticles(name)) boundsArr.push(l.getBounds());
      });
      if (!boundsArr.length) return;
      const bounds = boundsArr.reduce((acc,b)=>acc.extend(b), boundsArr[0]);
      map.fitBounds(bounds, { ...PADS, maxZoom: ZMAX - 0.1, animate:true });
    }

    /* POPUP HTML (desktop) – refined header + kortelės + inline onclick */
    function popupHTML(country, articles, onlyFirst){
      const shown = onlyFirst ? articles.slice(0,1) : articles;
      return `
        <div class="popup-card">
          <div class="popup-header">
            <div class="popup-flag"><i class="fa-solid fa-location-dot"></i></div>
            <div class="popup-title">${country}</div>
            <div class="popup-count">${articles.length} straipsniai</div>
          </div>
          <div class="popup-list">
            ${buildArticlesHTML(shown)}
          </div>
          <div class="popup-actions">
            ${
              onlyFirst && articles.length > 1
                ? `<button type="button" class="btn primary js-more" data-country="${country}" onclick="NN_more(event,this)">Rodyti daugiau</button>`
                : `<button type="button" class="btn ghost js-back" data-country="${country}" onclick="NN_back(event,this)">← Grįžti</button>`
            }
          </div>
        </div>`;
    }

    function buildArticlesHTML(list){
      return list.map(a=>`
        <div class="article">
          ${a.image ? `<img class="thumb" src="${a.image}" alt="">` : `<div class="thumb"></div>`}
          <div class="meta">
            <div class="title"><a href="${a.url}" target="_blank" rel="noopener">${a.title}</a></div>
            <div class="row"><span>${fmt(a.date)}</span>${a.niche?`<span class="badge">${a.niche}</span>`:''}</div>
            ${a.summary ? `<div class="summary">${a.summary}</div>` : ``}
          </div>
        </div>`).join("");
    }

    /* Globalūs handleriai popup mygtukams (PC) */
    function NN_afterPopupUpdate(){
      const p = map && map._popup;
      if (!p) return;
      p.update();
      setTimeout(()=>p.update(), 0); // dar kartą, kad Leaflet perskaičiuotų autopan'ą
      const el = p.getElement();
      if (el){
        const list = el.querySelector('.popup-list');
        if (list) list.scrollTop = 0; // kad niekas „neatsipjautų“
      }
    }
    function NN_more(ev, el){
      if (ev){ ev.preventDefault(); ev.stopPropagation(); }
      const c = el?.dataset?.country;
      const p = map && map._popup;
      if (!p || !c) return;
      p.setContent(popupHTML(c, filterArticles(c), false));
      NN_afterPopupUpdate();
    }
    function NN_back(ev, el){
      if (ev){ ev.preventDefault(); ev.stopPropagation(); }
      const c = el?.dataset?.country;
      const p = map && map._popup;
      if (!p || !c) return;
      p.setContent(popupHTML(c, filterArticles(c), true));
      NN_afterPopupUpdate();
    }
    window.NN_more = NN_more;
    window.NN_back = NN_back;

    /* ===== Mobile sheet handlers ===== */
    sheetActions.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button');
      if(!btn) return;
      ev.preventDefault();
      ev.stopPropagation();

      const action = btn.dataset.action;
      const country = btn.dataset.country;

      if (action==='more'){
        const all = filterArticles(country);
        sheetBody.innerHTML = buildArticlesHTML(all);
        sheetActions.innerHTML = `<button type="button" class="btn ghost" data-action="back" data-country="${country}">← Grįžti</button>`;
        sheetBody.scrollTop = 0;    // kad sąrašas prasidėtų nuo viršaus
      } else if (action==='back'){
        const first = filterArticles(country).slice(0,1);
        sheetBody.innerHTML = buildArticlesHTML(first);
        sheetActions.innerHTML = `<button type="button" class="btn primary" data-action="more" data-country="${country}">Rodyti daugiau</button>`;
        sheetBody.scrollTop = 0;    // kad sąrašas prasidėtų nuo viršaus
      }
    }, true);
  </script>
</body>
</html>