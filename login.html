<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>NewNews4You â€” Temos ir niÅ¡os</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --bg:#0b0f14; --panel:#0f141b; --muted:#aab3c0; --text:#eaf0f7;
      --brand:#49c6ff; --danger:#ff5d6c; --stroke:#121826;
      --radius:14px; --shadow:0 10px 40px rgba(0,0,0,.45); --input:#0e131d;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.45 "Inter",system-ui}
    .nav{height:56px;position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:12px;padding:0 14px;border-bottom:1px solid var(--stroke);background:rgba(10,13,18,.7);backdrop-filter:blur(6px)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}.brand i{color:var(--brand)}
    .spacer{flex:1}
    .back{display:inline-flex;align-items:center;gap:8px;background:#0c1118;color:#cfeeff;border:1px solid var(--stroke);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700}

    .wrap{min-height:calc(100vh - 56px);display:grid;place-items:start center;padding:24px 12px;}
    .card{width:min(880px,96vw);background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card.authed{grid-template-columns:1fr;width:min(680px,96vw)}
    @media (max-width:900px){.card{grid-template-columns:1fr}}

    .tabs{display:flex;background:#0c121b;border:1px solid var(--stroke);padding:6px;border-radius:12px;gap:6px;margin-bottom:14px}
    .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer;border-radius:10px;background:#0f1723;color:#cfe5ff;border:1px solid transparent;font-weight:700}
    .tab.active{background:var(--brand);color:#07121a}

    .pane{display:flex;flex-direction:column;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .label{font-size:.9rem;color:#cfe5ff}
    .input{width:100%;background:var(--input);color:var(--text);border:1px solid var(--stroke);border-radius:12px;padding:12px 14px;outline:none}
    .pwd{display:flex;align-items:center;background:var(--input);border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
    .pwd input{border:none;flex:1;background:transparent;padding:12px 14px;color:#fff;outline:none}
    .pwd button{border:none;background:#0f1723;color:#cfe5ff;padding:0 12px;height:100%;cursor:pointer}

    .btn{border:none;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--brand);color:#07121a}
    .btn.ghost{background:#101827;color:#dff6ff;border:1px solid var(--stroke)}
    .btn.danger{background:#2a1216;color:#ffd3d8;border:1px solid #3a1b22}

    .box{background:#0c121b;border:1px solid var(--stroke);border-radius:12px;padding:14px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    @media (max-width:520px){.grid{grid-template-columns:repeat(2,1fr)}}
    .chip{background:#101725;color:#cfe5ff;border:1px solid var(--stroke);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600;text-align:center}
    .chip.active{background:var(--brand);color:#07121a;border-color:transparent}
    .search{display:flex;align-items:center;gap:8px;background:#0e131d;border:1px solid var(--stroke);border-radius:12px;padding:8px 10px}
    .search input{flex:1;background:transparent;border:none;outline:none;color:#fff;padding:4px}

    .topic-item{background:#101827;border:1px solid var(--stroke);border-radius:10px;padding:8px 10px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .topic-item .x{background:#3d1c22;color:#ffd3d8;border:1px solid #4a232a;padding:6px 8px;border-radius:8px;cursor:pointer}

    .muted{color:var(--muted);font-size:.9rem}
    .msg{margin-top:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);display:none}
    .msg.ok{display:block;background:#0e1b15;color:#baffd5;border-color:#173c2e}
    .msg.err{display:block;background:#211217;color:#ffd0d7;border-color:#3b1b25}

    .loading{opacity:.6;pointer-events:none;filter:grayscale(.2)}
  </style>
</head>
<body>
<header class="nav">
  <div class="brand"><i class="fa-solid fa-globe"></i> NewNews4You</div>
  <div class="spacer"></div>
  <button class="back" id="backBtn"><i class="fa-solid fa-arrow-left"></i> GrÄ¯Å¾ti</button>
</header>

<main class="wrap">
  <section class="card" id="card">
    <!-- LEFT: auth -->
    <div id="leftCol">
      <div class="tabs">
        <button class="tab active" id="tabLogin">Prisijungti</button>
        <button class="tab" id="tabRegister">Registruotis</button>
      </div>

      <div class="pane" id="paneLogin">
        <div class="field">
          <label class="label" for="emailLogin">El. paÅ¡tas</label>
          <input id="emailLogin" type="email" class="input" autocomplete="email" />
        </div>
        <div class="field">
          <label class="label" for="passwordLogin">SlaptaÅ¾odis</label>
          <div class="pwd">
            <input id="passwordLogin" type="password" autocomplete="current-password"/>
            <button type="button" data-toggle="passwordLogin"><i class="fa-regular fa-eye"></i></button>
          </div>
        </div>
        <div class="row">
          <button class="btn primary" id="loginBtn">Prisijungti</button>
          <button class="btn ghost" id="forgotBtn" type="button">Priminti slaptaÅ¾odÄ¯</button>
        </div>
        <p class="muted">Neturite paskyros? <a href="#" id="toRegister">Sukurti</a></p>
        <div id="msgLogin" class="msg"></div>
      </div>

      <div class="pane" id="paneRegister" style="display:none">
        <div class="field">
          <label class="label" for="emailReg">El. paÅ¡tas</label>
          <input id="emailReg" type="email" class="input" autocomplete="email"/>
        </div>
        <div class="field">
          <label class="label" for="passwordReg">SlaptaÅ¾odis</label>
          <div class="pwd">
            <input id="passwordReg" type="password" autocomplete="new-password"/>
            <button type="button" data-toggle="passwordReg"><i class="fa-regular fa-eye"></i></button>
          </div>
          <span class="muted">Min. 6 simboliai</span>
        </div>
        <div class="field">
          <label class="label" for="confirmReg">Pakartoti slaptaÅ¾odÄ¯</label>
          <div class="pwd">
            <input id="confirmReg" type="password" autocomplete="new-password"/>
            <button type="button" data-toggle="confirmReg"><i class="fa-regular fa-eye"></i></button>
          </div>
        </div>
        <div class="row">
          <button class="btn primary" id="registerBtn">Registruotis</button>
          <button class="btn ghost" id="toLogin" type="button">Jau turiu paskyrÄ…</button>
        </div>
        <div id="msgReg" class="msg"></div>
      </div>
    </div>

    <!-- RIGHT: preferences -->
    <div id="panelUser" style="display:none">
      <div class="box" style="margin-bottom:14px">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="label">Prisijungta kaip</div>
            <div id="loggedInText" style="font-weight:800;margin-top:4px">â€“</div>
          </div>
          <button class="btn danger" id="logoutBtn">Atsijungti</button>
        </div>
      </div>

      <div class="box" style="margin-bottom:14px">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <h3 style="margin:0">Pasirinktos niÅ¡os</h3>
          <div class="search" style="min-width:220px">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input id="nicheSearch" type="text" placeholder="IeÅ¡koti niÅ¡Å³..." />
          </div>
        </div>
        <div id="nichesList" class="grid" style="margin-top:10px"></div>
      </div>

      <div class="box">
        <h3 style="margin-top:0">JÅ«sÅ³ temos</h3>
        <div class="row">
          <input id="newTopicInput" class="input" type="text" placeholder="Ä®veskite temÄ… ir spauskite + arba Enter" />
          <button class="btn ghost" id="addTopicBtn" type="button">+ PridÄ—ti</button>
        </div>
        <div id="customTopicsList" style="margin-top:10px;display:grid;gap:8px"></div>
      </div>

      <!-- Save button -->
      <div class="row" style="margin-top:16px;justify-content:flex-end">
        <button class="btn primary" id="saveBtn">ðŸ’¾ IÅ¡saugoti</button>
      </div>
      <div id="msgSave" class="msg"></div>
    </div>
  </section>
</main>

<script>
  // ---- Firebase init ----
  const firebaseConfig = {
    apiKey: "AIzaSyDzf4GlqlOEtCOYWdmpAz7n5BZvdb1QARg",
    authDomain: "news4you-f0976.firebaseapp.com",
    projectId: "news4you-f0976",
    storageBucket: "news4you-f0976.firebasestorage.app",
    messagingSenderId: "101311076335",
    appId: "1:101311076335:web:bbd5e29306269902e1881a",
    measurementId: "G-PTVWMT02K2"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // ---- Data ----
  const ALL_NICHES_BASE = [
    "Politika","Sportas","Technologijos","Sveikata","Verslas",
    "Automobiliai","Kriptovaliutos","Fotografija","Menas","Maistas",
    "Kinas","Å½aidimai","KelionÄ—s","Knygos","Muzika","Dirbtinis Intelektas",
    "Karas","KrepÅ¡inis","MMA","Å vietimas"
  ];
  const RSS_SOURCES_URL = "map_data/rss_sources.json";
  let TOPICS_FROM_FEEDS = [];
  let selectedNiches = [];
  let customTopics = [];
  let nichesFilter = "";

  // ---- Helpers ----
  const $ = s => document.querySelector(s);
  const show = (el, v=true)=> el.style.display = v ? "" : "none";
  const setMsg = (el, text, ok=false)=>{ el.textContent = text; el.className = "msg " + (ok ? "ok" : "err"); el.style.display = "block"; };
  const clearMsg = el => { el.textContent=""; el.className="msg"; el.style.display="none"; }
  const setLoading = (on)=> $("#card").classList.toggle("loading", !!on);

  function togglePwd(id){ const i=$("#"+id); i.type = i.type === "password" ? "text" : "password"; }
  document.querySelectorAll("[data-toggle]").forEach(btn=>{
    btn.addEventListener("click", ()=> togglePwd(btn.getAttribute("data-toggle")));
  });

  // ---- Read rss_sources
  async function loadTopicsFromFeeds(){
    try{
      const res = await fetch(RSS_SOURCES_URL, {cache:"no-store"});
      if (!res.ok) throw 0;
      const data = await res.json();
      TOPICS_FROM_FEEDS = Object.keys(data || {});
    }catch(_){ TOPICS_FROM_FEEDS = []; }
  }

  function mergedNiches(){
    return Array.from(new Set([...ALL_NICHES_BASE, ...customTopics, ...TOPICS_FROM_FEEDS]));
  }

  function renderNiches(selected=[]){
    selectedNiches = [...selected];
    const all = mergedNiches();
    const box = $("#nichesList");
    box.innerHTML = "";
    const term = nichesFilter.trim().toLowerCase();

    all.forEach(n=>{
      if (term && !n.toLowerCase().includes(term)) return;
      const b = document.createElement("button");
      b.className = "chip" + (selected.includes(n) ? " active": "");
      b.textContent = n;
      b.onclick = ()=>{
        b.classList.toggle("active");
        if (b.classList.contains("active")){
          if (!selectedNiches.includes(n)) selectedNiches.push(n);
        } else {
          selectedNiches = selectedNiches.filter(x=>x!==n);
        }
      };
      box.appendChild(b);
    });

    if (!box.children.length){
      const p=document.createElement('p'); p.className='muted'; p.textContent='Nerasta niÅ¡Å³ pagal paieÅ¡kÄ….'; box.appendChild(p);
    }
  }

  $("#nicheSearch").addEventListener('input', (e)=>{ nichesFilter = e.target.value; renderNiches(selectedNiches); });

  function renderTopics(){
    const list = $("#customTopicsList");
    list.innerHTML = "";
    customTopics.forEach((t,i)=>{
      const d = document.createElement("div");
      d.className = "topic-item";
      d.innerHTML = `<span>${t}</span><button class="x" data-i="${i}">PaÅ¡alinti</button>`;
      list.appendChild(d);
    });
    list.querySelectorAll(".x").forEach(btn=>{
      btn.onclick = ()=>{
        const idx = +btn.dataset.i;
        const topic = customTopics[idx];
        customTopics.splice(idx,1);
        selectedNiches = selectedNiches.filter(x=>x!==topic);
        renderTopics();
        renderNiches(selectedNiches);
      };
    });
  }

  $("#addTopicBtn").onclick = ()=>{
    const inp = $("#newTopicInput");
    const v = (inp.value||"").trim();
    if (!v) return;
    if (!customTopics.includes(v)) {
      customTopics.push(v);
      renderTopics();
      renderNiches(selectedNiches);
    }
    inp.value="";
  };
  $("#newTopicInput").addEventListener("keydown", e => { if (e.key === "Enter") $("#addTopicBtn").click(); });

  // ---- Auth actions ----
  $("#loginBtn").onclick = async ()=>{
    clearMsg($("#msgLogin"));
    const email = $("#emailLogin").value.trim();
    const pass  = $("#passwordLogin").value;
    if (!email || !pass){ setMsg($("#msgLogin"), "UÅ¾pildykite el. paÅ¡tÄ… ir slaptaÅ¾odÄ¯"); return; }
    setLoading(true);
    try{
      await auth.signInWithEmailAndPassword(email, pass);
      setMsg($("#msgLogin"), "Prisijungta!", true);
    }catch(e){ setMsg($("#msgLogin"), e.message); }
    setLoading(false);
  };
  $("#registerBtn").onclick = async ()=>{
    clearMsg($("#msgReg"));
    const email = $("#emailReg").value.trim();
    const pass  = $("#passwordReg").value;
    const conf  = $("#confirmReg").value;
    if (!email || !pass || !conf){ setMsg($("#msgReg"), "UÅ¾pildykite visus laukus"); return; }
    if (pass.length < 6){ setMsg($("#msgReg"), "SlaptaÅ¾odis per trumpas (min. 6)"); return; }
    if (pass !== conf){ setMsg($("#msgReg"), "SlaptaÅ¾odÅ¾iai nesutampa"); return; }
    setLoading(true);
    try{
      await auth.createUserWithEmailAndPassword(email, pass);
      setMsg($("#msgReg"), "Registracija sÄ—kminga!", true);
      document.getElementById("tabLogin").click();
    }catch(e){ setMsg($("#msgReg"), e.message); }
    setLoading(false);
  };
  $("#forgotBtn").onclick = async ()=>{
    const email = ($("#emailLogin").value||"").trim();
    if (!email){ setMsg($("#msgLogin"), "Ä®veskite el. paÅ¡tÄ… ir spauskite â€žPrimintiâ€œ"); return; }
    setLoading(true);
    try{ await auth.sendPasswordResetEmail(email); setMsg($("#msgLogin"), "IÅ¡siÅ³sta slaptaÅ¾odÅ¾io atstatymo nuoroda!", true); }
    catch(e){ setMsg($("#msgLogin"), e.message); }
    setLoading(false);
  };
  $("#logoutBtn").onclick = ()=> auth.signOut();

  // Save button handler
  document.getElementById("saveBtn").onclick = async ()=>{
    if (!auth.currentUser){ setMsg($("#msgSave"), "NeprisijungÄ™s vartotojas!"); return; }
    setLoading(true);
    try{
      await db.collection("users").doc(auth.currentUser.uid).set({
        niches: selectedNiches,
        customTopics: customTopics
      }, { merge:true });
      setMsg($("#msgSave"), "IÅ¡saugota sÄ—kmingai!", true);
    }catch(e){ setMsg($("#msgSave"), "Klaida saugant: "+e.message); }
    setLoading(false);
  };

  // Save
  document.addEventListener("click", e=>{
    if (e.target && e.target.id === "toLogin"){ e.preventDefault(); document.getElementById("tabLogin").click(); }
    if (e.target && e.target.id === "toRegister"){ e.preventDefault(); document.getElementById("tabRegister").click(); }
  });

  // Tabs
  const tabLogin = document.getElementById("tabLogin");
  const tabRegister = document.getElementById("tabRegister");
  tabLogin.addEventListener("click", ()=>{ tabLogin.classList.add("active"); tabRegister.classList.remove("active"); show(document.getElementById("paneLogin"),true); show(document.getElementById("paneRegister"),false); });
  tabRegister.addEventListener("click", ()=>{ tabRegister.classList.add("active"); tabLogin.classList.remove("active"); show(document.getElementById("paneRegister"),true); show(document.getElementById("paneLogin"),false); });

  // Back
  document.getElementById("backBtn").onclick = ()=>{ if (document.referrer) history.back(); else window.location.href = "zemelepai/region_map.html"; };

  // ---- Auth state ----
  auth.onAuthStateChanged(async user=>{
    const card = document.getElementById("card");
    clearMsg(document.getElementById("msgLogin")); clearMsg(document.getElementById("msgReg"));

    await loadTopicsFromFeeds();

    if (user){
      show(document.getElementById("leftCol"), false);
      show(document.getElementById("panelUser"), true);
      card.classList.add("authed");
      document.getElementById("loggedInText").textContent = user.email;

      try{
        const doc = await db.collection("users").doc(user.uid).get();
        const data = doc.exists ? doc.data() : {};
        selectedNiches = data.niches || [];
        customTopics   = data.customTopics || [];
      }catch(_){
        selectedNiches=[]; customTopics=[];
      }
      renderTopics();
      renderNiches(selectedNiches);
    }else{
      show(document.getElementById("leftCol"), true);
      show(document.getElementById("panelUser"), false);
      card.classList.remove("authed");
      selectedNiches=[]; customTopics=[];
      renderTopics();
      renderNiches([]);
    }
  });

  window.addEventListener("DOMContentLoaded", async ()=>{
    await loadTopicsFromFeeds();
    renderNiches([]);
  });
</script>
</body>
</html>
